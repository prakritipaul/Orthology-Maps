---
title: "ciona_larvae_clustering"
output: html_document
---
# Works in parallel with zeb_degs_heatmaps 
# Has routines present in both zeb_24hpf_clustering.Rmd and zeb_degs_heatmaps.Rmd, 
# due to simplicity of Ciona data

# Uses env_ciona_larvae_clustering.RData

# Makes integrated Seurat object
# Clusters
# Tissue Mapping
# (1) Get Cells (2) Get DEGs (3) Make top50 vectors (4) Heatmaps


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=TRUE}
library(Seurat)
library(dplyr)
library(ggplot2)
library(purrr)
library(Hmisc)
library(pvclust)
```

# Markers 
```{r include=TRUE}
dopa_markers = c("KH2012:KH.C10.200", "KH2012:KH.C3.666")
cns_markers = c("KH2012:KH.C14.4", "KH2012:KH.C1.127", "KH2012:KH.C7.59", "KH2012:KH.C6.224")
noto_markers = c("KH2012:KH.C5.124", "KH2012:KH.C8.749")
epi_markers = c("KH2012:KH.C1.611", "KH2012:KH.C8.844")
mes_markers = c("KH2012:KH.C5.228", "KH2012:KH.C5.202", "KH2012:KH.C1.222")
endo_markers = c("KH2012:KH.C5.227", "KH2012:KH.S1012.1")
mus_markers = c("KH2012:KH.S423.6", "KH2012:KH.L116.38", "KH2012:KH.C7.504")
heart_markers = c("KH2012:KH.C7.205")
```


################################################################################################

"""
Helper Function: Make Seurat Object and Find n_features Variable Genes
"""
```{r include=TRUE}
make_ciona_seurat <- function(ciona_df, min_cells, min_features, n_features){
  ciona_seurat <- CreateSeuratObject(counts = ciona_df,
                                     min.cells = min_cells, 
                                     min.features = min_features)
  
  ciona_seurat <- NormalizeData(object = ciona_seurat)
  ciona_seurat <- FindVariableFeatures(ciona_seurat, 
                                       selection.method = "vst",
                                       nfeatures = n_features)
  return(ciona_seurat)
}
```

"""
-First 3 variables were used to make larva*_seurats
-chen_ciona_min_cells, chen_min/max_features same for chen_larva*_seurats
-chen_max_features_ depend on nGene distributions for each larva*_seurat_1/2 
came from mean and sd of corresponding larva seurats 
"""
```{r include=TRUE}
ciona_min_cells <- 3
ciona_min_features <- 200
ciona_n_features <- 2000

chen_ciona_min_cells <- 3
chen_min_features <- 1000
chen_max_features <- 5000

# unused 
chen_max_features_1 <- 528+5*705
chen_max_features_2 <- 1002+5*1012
```

# (1) Make Larva Seurats
```{r include=TRUE}
# 28234
larva1_seurat <- make_ciona_seurat(larva1_matrix, ciona_min_cells, ciona_min_features, ciona_n_features)
# 12406
larva2_seurat <- make_ciona_seurat(larva2_matrix, ciona_min_cells, ciona_min_features, ciona_n_features)
# 7144
larva3_seurat <- make_ciona_seurat(larva3_matrix, ciona_min_cells, ciona_min_features, ciona_n_features)
```

"""
Look at Larva* Distributions 
"""
```{r include=TRUE}
density_testing_seurat <- chen_larva3_seurat_scaled
var_features <- chen_larva3_seurat_scaled@assays$RNA@var.features

# var_features[1:10]
VlnPlot(object = density_testing_seurat, features = c("nFeature_RNA", "nCount_RNA"))
```

```{r include=TRUE}
n_count_density <- density(density_testing_seurat$nCount_RNA)
n_feats <- density_testing_seurat$nFeature_RNA
n_feat_density <- density(n_feats)

n_feat_density
plot(n_feat_density)

cat("mean = ", mean(n_feats), "\n\n")
cat("sd = ", sd(n_feats), "\n\n")
cat("5 sd's above mean = ", mean(n_feats)+sd(n_feats)*5)
```

"""
Now subset based on chen_max_features -> chen_larva_seurat
"""

```{r include=TRUE}
chen_larva1_seurat <- subset(larva1_seurat, subset = nFeature_RNA > chen_min_features & nFeature_RNA < chen_max_features)
```

```{r include=TRUE}
chen_larva2_seurat <- subset(larva2_seurat, subset = nFeature_RNA > chen_min_features & nFeature_RNA < chen_max_features)
```

```{r include=TRUE}
chen_larva3_seurat <- subset(larva3_seurat, subset = nFeature_RNA > chen_min_features & nFeature_RNA < chen_max_features)
```

"""
Add MetaData that reflects batch #
"""
```{r include=TRUE}
chen_len_1 <- length(colnames(x = chen_larva1_seurat))
metadata_1 <- rep("larva1", chen_len_1)

chen_larva1_seurat$larva_batch <- metadata_1
chen_larva1_seurat_scaled$larva_batch <- metadata_1

# 2
chen_len_2 <- length(colnames(x = chen_larva2_seurat))
metadata_2 <- rep("larva2", chen_len_2)

chen_larva2_seurat$larva_batch <- metadata_2
chen_larva2_seurat_scaled$larva_batch <- metadata_2

# 3
chen_len_3 <- length(colnames(x = chen_larva3_seurat))
metadata_3 <- rep("larva3", chen_len_3)

chen_larva3_seurat$larva_batch <- metadata_3
chen_larva3_seurat_scaled$larva_batch <- metadata_3

```

"""
Scale, PCA, TSNE 
"""
```{r include=TRUE}
ElbowPlot(chen_larva3_seurat_scaled)
```

```{r include=TRUE}
chen_larva1_seurat_scaled <- chen_larva1_seurat

chen_larva1_seurat_scaled <- ScaleData(chen_larva1_seurat_scaled)

chen_larva1_seurat_scaled <- RunPCA(chen_larva1_seurat_scaled, npcs = 10, verbose = FALSE)
chen_larva1_seurat_scaled <- RunTSNE(chen_larva1_seurat_scaled, npcs = 10, verbose = FALSE)
```

```{r include=TRUE}
chen_larva2_seurat_scaled <- chen_larva2_seurat

chen_larva2_seurat_scaled <- ScaleData(chen_larva2_seurat_scaled)

chen_larva2_seurat_scaled <- RunPCA(chen_larva2_seurat_scaled, npcs = 10, verbose = FALSE)
chen_larva2_seurat_scaled <- RunTSNE(chen_larva2_seurat_scaled, npcs = 10, verbose = FALSE)
```

```{r include=TRUE}
chen_larva3_seurat_scaled <- chen_larva3_seurat

chen_larva3_seurat_scaled <- ScaleData(chen_larva3_seurat_scaled)

chen_larva3_seurat_scaled <- RunPCA(chen_larva3_seurat_scaled, npcs = 10, verbose = FALSE)
chen_larva3_seurat_scaled <- RunTSNE(chen_larva3_seurat_scaled, npcs = 10, verbose = FALSE)
```

"""
Cluster + Map Tissues
"""
```{r include=TRUE}
chen_larva1_seurat_scaled <- FindNeighbors(chen_larva1_seurat_scaled, dims = 1:10)
chen_larva1_seurat_scaled <- FindClusters(chen_larva1_seurat_scaled, resolution = 1)
```

```{r include=TRUE}
chen_larva2_seurat_scaled <- FindNeighbors(chen_larva2_seurat_scaled, dims = 1:10)
chen_larva2_seurat_scaled <- FindClusters(chen_larva2_seurat_scaled, resolution = 0.5)
```

```{r include=TRUE}
chen_larva3_seurat_scaled <- FindNeighbors(chen_larva3_seurat_scaled, dims = 1:10)
chen_larva3_seurat_scaled <- FindClusters(chen_larva3_seurat_scaled, resolution = 0.5)
```

"""
Visualize + Map Tissues
"""
```{r include=TRUE}
DimPlot(chen_larva2_seurat_scaled, 
        reduction = "tsne",
        label = TRUE)
```

```{r include=TRUE}

FeaturePlot(object = chen_larva3_seurat_scaled,
            features = endo_markers,
            reduction = "tsne",
            label = TRUE)
```

"""
Figure out which clusters you will throw away
"""
```{r include=TRUE}
table(Idents(chen_larva1_seurat_scaled))
```

"""
Create "Clean Seurat Objects" from chen_larva*_seurats (Not scaled!) that lack above clusters
"""
# 1
```{r include=TRUE}
cells_to_remove_1 <- WhichCells(chen_larva1_seurat_scaled,
                                idents = 3)

cells_to_keep_1 <- setdiff(colnames(chen_larva1_seurat_scaled), cells_to_remove_1)

clean_chen_larva1_seurat <- subset(chen_larva1_seurat,
                                   cells = cells_to_keep_1)
```

# 2
```{r include=TRUE}
cells_to_remove_2 <- WhichCells(chen_larva2_seurat_scaled,
                                idents = c(6, 13))

cells_to_keep_2 <- setdiff(colnames(chen_larva2_seurat_scaled), cells_to_remove_2)

clean_chen_larva2_seurat <- subset(chen_larva2_seurat,
                                   cells = cells_to_keep_2)
```

# 3
```{r include=TRUE}
cells_to_remove_3 <- WhichCells(chen_larva3_seurat_scaled,
                                idents = c(12, 14, 15, 16, 18))

cells_to_keep_3 <- setdiff(colnames(chen_larva3_seurat_scaled), cells_to_remove_3)

clean_chen_larva3_seurat <- subset(chen_larva3_seurat,
                                   cells = cells_to_keep_3)
```

"""
Let's now proceed with Batch Correction Procedure
"""

```{r include=TRUE}
clean_chen_larva_list <- list(clean_chen_larva1_seurat, clean_chen_larva2_seurat, clean_chen_larva3_seurat)
```

"""
Helper Function for Integration 
"""
```{r include=TRUE}
# ~30 mins
make_integrated_seurat <- function(object_list, dims){
  # Args:
    # object_list: list of Seurat objects. e.g. zeb_seurat_list.
    # dims: input dimensions for FindIntegrationAnchors and IntegrateData. 
    # npcs: # pcs for PCA and TSNE.
  
  # Routine: Do integration. Scale.
  
  # Returns:
    # integrated_seurat: output of above routine.
  
  zeb_anchors <- FindIntegrationAnchors(object.list = object_list,
                                      dims = 1:dims)
  zeb_integrated <- IntegrateData(anchorset = zeb_anchors, dims = 1:dims)
  
  DefaultAssay(zeb_integrated) <- "integrated"
  
  zeb_integrated <- ScaleData(zeb_integrated, verbose = FALSE)
  
  return(zeb_integrated)
}
```

"""
Pick #Anchors (20)
"""
```{r include=TRUE}
# ~6 mins
clean_chen_larva_integrated_20 <- make_integrated_seurat(clean_chen_larva_list, 20)
```

"""
Perform PCA, TSNE
"""
```{r include=TRUE}
npcs <- 15
clean_chen_larva_integrated_20 <- RunPCA(clean_chen_larva_integrated_20, npcs = npcs, verbose = FALSE)
clean_chen_larva_integrated_20 <- RunTSNE(clean_chen_larva_integrated_20, dims = 1:npcs)
```

```{r include=TRUE}
ElbowPlot(clean_chen_larva_integrated_20)
```

"""
Ensure that Batch Correction worked
"""
```{r include=TRUE}
# Beautiful!
DimPlot(clean_chen_larva_integrated_20, 
        reduction = "tsne",
        label = TRUE,
        group.by = "larva_batch")
```

"""
Visualize + Map Tissues
"""
```{r include=TRUE}
clean_chen_larva_integrated_20 <- FindNeighbors(clean_chen_larva_integrated_20, dims = 1:15)
clean_chen_larva_integrated_20 <- FindClusters(clean_chen_larva_integrated_20, resolution = 1)
```

```{r include=TRUE}
DimPlot(clean_chen_larva_integrated_20, 
        reduction = "tsne",
        label = TRUE)
```

```{r include=TRUE}

FeaturePlot(object = clean_chen_larva_integrated_20,
            features = heart_markers,
            reduction = "tsne",
            label = TRUE)
```



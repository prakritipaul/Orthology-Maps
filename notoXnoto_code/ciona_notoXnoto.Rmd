---
title: "notoXnoto"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(Seurat)
library(dplyr)
library(ggplot2)
library(purrr)
library(Hmisc)
library(pvclust)
library(stringr)
library(cellranger)
```

################### PART 1: Get Chen's Raw 4D Data #######################
# https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE131155
# General dims: 15269 x 737280

################### START ENTIRE PIPELINE FOR INIG ####################

# (iniG/C110) https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSM3764764
```{r include=TRUE}
chen_4D_dir <- "/home/pprakriti/princeton_google_drive/Levine Lab/Orthology-Maps/Raw_Data/4D_GSE131155_RAW/"
```

```{r include=TRUE}
iniG1_name <- "GSM3764764_iniG1_raw_gene_bc_matrices_h5.h5"
iniG2_name <- "GSM3764765_iniG2_raw_gene_bc_matrices_h5.h5" 
```

# Validate with larva
```{r include=TRUE}
larva1_name <- "GSM3764784_larva1_raw_gene_bc_matrices_h5.h5"
larva2_name <- "GSM3764785_larva2_raw_gene_bc_matrices_h5.h5"
larva3_name <- "GSM3764786_larva3_raw_gene_bc_matrices_h5.h5"
```

# Helper Function
```{r include=TRUE}
get_raw_matrix <- function(h5_dir, stage_name) {
  # Extracts raw matrix from h5 file.
  #
  # Args:
  #   h5_dir: Directory containing all h5 files. 
  #           e.g. "Orthology-Maps/.../Chen_4D/"
  #   stage_dir: Name of h5 file. 
  #           e.g. "GSM3764764_iniG1_raw_gene_bc_matrices_h5.h5"
  #
  # Returns:
  #   raw_matrix
  h5 <- paste(h5_dir, stage_name, sep = "")
  raw_matrix <- Read10X_h5(h5)
  return(raw_matrix)
}
```

#####################################################################################

# (1) Get raw matrices. 
# iniG
# 15269 x 737281
```{r include=TRUE}
iniG1_raw_matrix <- get_raw_matrix(chen_4D_dir, iniG1_name)
iniG2_raw_matrix <- get_raw_matrix(chen_4D_dir, iniG2_name)
```

# Larva 
# 15269 x 737281
```{r include=TRUE}
larva1_raw_matrix <- get_raw_matrix(chen_4D_dir, larva1_name)
larva2_raw_matrix <- get_raw_matrix(chen_4D_dir, larva2_name)
larva3_raw_matrix <- get_raw_matrix(chen_4D_dir, larva3_name)
```

#####################################################################################

# iniG
```{r include=TRUE}
test_raw_matrix <- iniG1_raw_matrix
test_raw_matrix_2 <- iniG2_raw_matrix
```

# Larva
```{r include=TRUE}
test_raw_matrix_l1 <- larva1_raw_matrix
test_raw_matrix_l2 <- larva2_raw_matrix
test_raw_matrix_l3 <- larva3_raw_matrix
```

#####################################################################################

# (2) Helper Function: Do filtering steps to get number of filtered Variable Features.

#####################################################################################
```{r include=TRUE}
make_filtered_seurat <- function(raw_matrix, min_cells, min_features) {
  # Filters Seurat Object to get number of filtered features that will be used
  # as number of VariableFeatures for all Seurat Objects to be integrated.
  # e.g. 2 Seurat Objects have 14310 and 12837 filtered features respectively.
  # Downstream, both Seurat Objects will use 12830 n_features in FindVariableFeatures. 
  seurat_object <- CreateSeuratObject(counts = raw_matrix,  
                                    min.cells = min_cells,
                                    min.features =  min_features)
  return(seurat_object)
}
```

# iniG
```{r include=TRUE}
# 14310 x 68708
test_seurat <- make_filtered_seurat(test_raw_matrix, 3, 200)
# 12830 x 1422
test_seurat_2 <- make_filtered_seurat(test_raw_matrix_2, 3, 200)
```

# Larva
```{r include=TRUE}
# 13933 x 28234
test_seurat_l1 <- make_filtered_seurat(test_raw_matrix_l1, 3, 200)
# 13907 x 12405
test_seurat_l2 <- make_filtered_seurat(test_raw_matrix_l2, 3, 200)
# 14067 x 7143
test_seurat_l3 <- make_filtered_seurat(test_raw_matrix_l3, 3, 200)

```

#####################################################################################
# (3) Add Metadata 
#####################################################################################
```{r include=TRUE}
add_metadata <- function(seurat_object, flag) {
  # Adds batch_name metadata for seurat_object.
  # e.g. "iniG1" is a flag.
  metadata_len <- length(colnames(x = seurat_object))
  metadata <- rep(flag, metadata_len)
  seurat_object$batch_name <- metadata
  
  return(seurat_object)
}
```

# iniG
```{r include=TRUE}
test_seurat <- add_metadata(test_seurat, "iniG1")
test_seurat_2 <- add_metadata(test_seurat_2, "iniG2")
```

# Larva
```{r include=TRUE}
test_seurat_l1 <- add_metadata(test_seurat_l1, "larva1")
test_seurat_l2 <- add_metadata(test_seurat_l2, "larva2")
test_seurat_l3 <- add_metadata(test_seurat_l3, "larva3")
```

#####################################################################################

# (4) Helper Function: Get the min of filtered features.

#####################################################################################

```{r include=TRUE}
get_n_features <- function(seurat_object) {
  n_features <- seurat_object@assays$RNA@counts@Dim[[1]]
  return(n_features)
}

get_min_n_features <- function(seurat_object_list) {
  n_features <- sapply(X = seurat_object_list, FUN = get_n_features)
  min_n_features_1 <- min(n_features)
  min_n_features <- floor(min_n_features_1/10)*10 
  return(min_n_features)
}
```

# List of Seurat Objects
# iniG
```{r include=TRUE}
test_seurat_object_list <- list(test_seurat, test_seurat_2)
```

# Larva
```{r include=TRUE}
test_seurat_object_list_2 <- list(test_seurat_l1, test_seurat_l2, test_seurat_l3)
```

#####################################################################################

# iniG
```{r include=TRUE}
# 12830
test_min_n_features <- get_min_n_features(test_seurat_object_list)
```

# Larva
```{r include=TRUE}
test_min_n_features_2 <- get_min_n_features(test_seurat_object_list_2)
```

#####################################################################################

# (5) Continue making Seurat Objects using test_min_features as nFeatures.

```{r include=TRUE}
continue_make_seurat <- function(seurat_object, min_features) {
  seurat_object <- NormalizeData(object = seurat_object)
  seurat_object <- FindVariableFeatures(seurat_object, 
                                      selection.method = "vst",
                                      nfeatures = min_features)
  return(seurat_object)
}
```

# Use above function to test_seurat_object_list -> test_seurat_object_list_cont.
# These will be used for integration in gencomp.
```{r include=TRUE}
test_seurat_object_list_cont_2 <- lapply(test_seurat_object_list_2, FUN = continue_make_seurat, test_min_n_features_2)
```

#####################################################################################

Test Integration on Larva

#####################################################################################

# Testing rest of pipeline on larva
```{r include=TRUE}
make_integrated_seurat <- function(object_list_cont, dims, n_anchor_features){
  # Args:
  #   object_list_cont: list of Seurat objects. e.g. zeb_seurat_list.
  #   dims: input dimensions for FindIntegrationAnchors and IntegrateData.
  #         Ciona=20, Zeb=50
  #   n_anchor_features: min_n_features. 
  
  # Routine: Do integration. 
  
  # Returns:
  #   integrated_seurat: output of above routine.
  
  anchors <- FindIntegrationAnchors(object.list = object_list_cont,
                                    dims = 1:dims,
                                    anchor.features = n_anchor_features)
  
  integrated_seurat <- IntegrateData(anchorset = anchors, dims = 1:dims)
  
  DefaultAssay(integrated_seurat) <- "integrated"
  
  return(integrated_seurat)
}
```

# Testing rest of pipeline on Larva
```{r include=TRUE}
test_integrated_seurat_2 <- make_integrated_seurat(test_seurat_object_list_cont_2,
                                                 dims = 20,
                                                 n_anchor_features = test_min_n_features_2)
```

################### END ENTIRE PIPELINE FOR INIG ####################


################### START POST-GENCOMP #####################

# (1) Import Seurat Object and Data
# (2) Check Batch Correction 

################### END POST-GENCOMP #####################

